import random
import urllib.request
import json
from PIL import Image
from io import BytesIO
import requests
import sqlite3


# ------------------------ Datenbank fÃ¼r Highscores ------------------------
def create_highscore_db():
    """Erstellt die SQLite-Datenbank fÃ¼r die Highscores, falls sie noch nicht existiert."""
    conn = sqlite3.connect('highscores.db')
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS highscores (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            player_name TEXT,
            score INTEGER
        )
    ''')
    conn.commit()
    conn.close()


def save_highscore(player_name, score):
    conn = sqlite3.connect('highscores.db')
    c = conn.cursor()
    c.execute('INSERT INTO highscores (player_name, score) VALUES (?, ?)', (player_name, score))
    conn.commit()
    conn.close()


def get_top_highscores(limit=5):
    conn = sqlite3.connect('highscores.db')
    c = conn.cursor()
    c.execute('SELECT player_name, score FROM highscores ORDER BY score DESC LIMIT ?', (limit,))
    top_scores = c.fetchall()
    conn.close()
    return top_scores


# ------------------------ LÃ¤nder-Daten abrufen ------------------------
def get_country_data():
    url = "https://restcountries.com/v3.1/all"
    try:
        import ssl
        context = ssl._create_unverified_context()
        with urllib.request.urlopen(url, context=context) as response:
            data = json.loads(response.read().decode())

        country_dict = {}
        for country in data:
            name = country.get('name', {}).get('common', 'Unbekannt')
            capital = country.get('capital', ['Unbekannt'])[0]
            population = country.get('population', 'Unbekannt')
            flag_url = country.get('flags', {}).get('png', 'Keine Flagge verfÃ¼gbar')
            country_dict[name] = {'capital': capital, 'population': population, 'flag': flag_url}

        return country_dict
    except Exception as e:
        print(f"Fehler beim Abruf der Daten: {e}")
        return {}


# ------------------------ Spielregeln ------------------------
def show_rules():
    print("\nğŸ“œ Spielablauf:")
    print("1. WÃ¤hle die Anzahl der Spieler, Namen, Schwierigkeitsstufe und Rundenanzahl.")
    print("2. Es wird eine zufÃ¤llige Flagge angezeigt. Errate das passende Land.")
    print("3. Danach wird die Hauptstadt und die Einwohnerzahl des Landes abgefragt.")
    print("4. FÃ¼r jede richtige Antwort gibt es einen Punkt.")
    print("5. Der Spieler mit den meisten Punkten gewinnt!")
    print("\nğŸ® Schwierigkeitsstufen:")
    print("- AnfÃ¤nger: Multiple-Choice-Fragen")
    print("- Pro: Direkte Antwort ohne AuswahlmÃ¶glichkeiten")
    print("\nğŸ† Highscore:")
    print("- Die besten 5 Spieler werden in der Rangliste angezeigt.")
    print("- Kannst du den Highscore knacken? ğŸ˜‰\n")


def ask_for_rules():
    while True:
        try:
            rules_choice = input("ğŸ“‹ MÃ¶chtest du die Spielregeln sehen? (Ja/Nein): ").strip().lower()
            if rules_choice in ["ja", "nein"]:
                if rules_choice == "ja":
                    show_rules()
                break
            else:
                raise ValueError("âš ï¸ UngÃ¼ltige Eingabe! Bitte Ja oder Nein angeben.")
        except ValueError as e:
            print(e)


# ------------------------ Spielvorbereitung ------------------------
def get_player_count():
    while True:
        try:
            count = int(input("ğŸ‘¥ Wie viele Spieler spielen mit? "))
            if count > 0:
                return count
            else:
                print("âš ï¸ Bitte eine Zahl grÃ¶ÃŸer als 0 eingeben.")
        except ValueError:
            print("âš ï¸ UngÃ¼ltige Eingabe. Bitte eine Zahl eingeben.")


def greet_players(player_count):
    players = []
    for i in range(1, player_count + 1):
        name = input(f"ğŸ‘¤ Spieler {i}, wie heiÃŸt du? ")
        players.append(name)
        print(f"Willkommen, {name}! ğŸ˜Š")
    return players


def choose_difficulty():
    while True:
        difficulty = input("ğŸ’¡ WÃ¤hle den Schwierigkeitsgrad (1 = AnfÃ¤nger | 2 = Pro): ").strip().lower()
        if difficulty in ["1", "anfÃ¤nger"]:
            return "anfÃ¤nger"
        elif difficulty in ["2", "pro"]:
            return "pro"
        else:
            print("âš ï¸ Bitte 1 fÃ¼r 'AnfÃ¤nger' oder 2 fÃ¼r 'Pro' eingeben.")


def start_game():
    print("\nğŸŒ Willkommen bei Capture the Flag - Flaggen-Quiz!")
    ask_for_rules()

    player_count = get_player_count()
    players = greet_players(player_count)
    difficulty = choose_difficulty()
    rounds = int(input("ğŸ” Wie viele Runden mÃ¶chtest du spielen? "))

    country_data = get_country_data()
    country_names = list(country_data.keys())
    score = {player: 0 for player in players}

    # ------------------------ Spielrunden ------------------------
    for _ in range(rounds):
        country = random.choice(country_names)  # ZufÃ¤lliges Land auswÃ¤hlen
        flag_url = country_data[country]['flag']  # URL der Flagge
        Image.open(BytesIO(requests.get(flag_url).content)).show()  # Flagge anzeigen
        capital = country_data[country]['capital']  # Hauptstadt
        population = country_data[country]['population']  # BevÃ¶lkerung

        # Fragen fÃ¼r jeden Spieler
        for player in players:
            print(f"\n{player}, du bist dran!")

            # Land erraten
            if difficulty == "anfÃ¤nger":
                choices = random.sample(country_names, 3) + [country]
                random.shuffle(choices)
                for i, choice in enumerate(choices, 1):
                    print(f"{i}. {choice}")
                answer = input("ğŸŒ WÃ¤hle die richtige Nummer: ")
                if choices[int(answer) - 1] == country:
                    score[player] += 1
                    print("âœ… Richtig!")
                else:
                    print(f"âŒ Falsch! Die richtige Antwort war {country}.")
            else:
                answer = input("ğŸŒ Nenne das Land zur Flagge: ")
                if answer.strip().lower() == country.lower():
                    score[player] += 1
                    print("âœ… Richtig!")
                else:
                    print(f"âŒ Falsch! Die richtige Antwort war {country}.")

            # Hauptstadt erraten
            capital_answer = input(f"ğŸ™ï¸ Was ist die Hauptstadt von {country}? ")
            if capital_answer.strip().lower() == capital.lower():
                score[player] += 1
                print("âœ… Richtig!")
            else:
                print(f"âŒ Falsch! Die richtige Antwort war {capital}.")

            # Einwohnerzahl erraten
            population_answer = input(f"ğŸ‘¥ Wie viele Einwohner hat {country}? (Grobe SchÃ¤tzung erlaubt) ")
            if population_answer.replace(',', '').isdigit():
                print(f"â„¹ï¸ Die tatsÃ¤chliche Einwohnerzahl ist {population}.")
            else:
                print("âš ï¸ UngÃ¼ltige Eingabe.")

    # ------------------------ Endergebnisse ------------------------
    print("\nğŸ‰ Spiel beendet! Punktestand:")
    for player, points in score.items():
        print(f"ğŸ… {player}: {points} Punkte")

    # ------------------------ Highscores ------------------------
    print("\nğŸ† Highscore:")
    for player, points in score.items():
        save_highscore(player, points)

    # Top 5 Highscores anzeigen
    print("\nğŸ”¥ Die besten 5 Spieler aller Zeiten:")
    top_scores = get_top_highscores()
    for i, (player_name, score) in enumerate(top_scores, 1):
        print(f"{i}. {player_name} - {score} Punkte")


# ------------------------ Hauptfunktion ------------------------
if __name__ == "__main__":
    create_highscore_db()  # Datenbank fÃ¼r Highscores erstellen
    start_game()